name: Coq Verification

on:
  push:
    branches: [ main ]
    paths:
      - '**.v'
      - '_CoqProject'
      - 'coq-*.opam'
      - '.github/workflows/coq.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**.v'
      - '_CoqProject'
      - 'coq-*.opam'
      - '.github/workflows/coq.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        coq-version:
          - '8.18'
          - 'latest'
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for Coq files
      id: check-coq
      run: |
        if [ -f "_CoqProject" ] || find . -name "*.v" -print -quit | grep -q .; then
          echo "has_files=true" >> $GITHUB_OUTPUT
        else
          echo "has_files=false" >> $GITHUB_OUTPUT
          echo "No Coq files found - skipping build"
          echo "To use Coq verification, add Coq source files (.v) and optionally a _CoqProject file"
        fi

    - name: Build Coq project using docker-coq-action
      if: steps.check-coq.outputs.has_files == 'true'
      uses: coq-community/docker-coq-action@v1
      with:
        coq_version: ${{ matrix.coq-version }}
        custom_script: |
          startGroup "Coq version"
            coqc --version
          endGroup
          startGroup "Verify Coq files"
            if [ -f "_CoqProject" ]; then
              echo "Building Coq project with _CoqProject..."
              coq_makefile -f _CoqProject -o Makefile.coq
              make -f Makefile.coq
            else
              echo "Verifying Coq files..."
              find . -name "*.v" -type f | while read -r file; do
                echo "Checking: $file"
                coqc "$file" && echo "✓ $file verified successfully" || exit 1
              done
            fi
            echo "✓ All Coq files verified successfully!"
          endGroup
