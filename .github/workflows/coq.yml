name: Coq Verification

on:
  push:
    branches: [ main ]
    paths:
      - '**.v'
      - '_CoqProject'
      - 'coq-*.opam'
      - '.github/workflows/coq.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**.v'
      - '_CoqProject'
      - 'coq-*.opam'
      - '.github/workflows/coq.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        coq-version:
          - '8.18'
          - 'latest'
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for Coq files
      id: check-coq
      run: |
        if [ -f "_CoqProject" ] || find . -name "*.v" -print -quit | grep -q .; then
          echo "has_files=true" >> $GITHUB_OUTPUT
        else
          echo "has_files=false" >> $GITHUB_OUTPUT
          echo "No Coq files found - skipping build"
          echo "To use Coq verification, add Coq source files (.v) and optionally a _CoqProject file"
        fi

    - name: Set up OCaml
      if: steps.check-coq.outputs.has_files == 'true'
      uses: ocaml/setup-ocaml@v2
      with:
        ocaml-compiler: 4.14.x

    - name: Install Coq
      if: steps.check-coq.outputs.has_files == 'true'
      run: |
        opam install coq.${{ matrix.coq-version }} -y
        opam install coq-mathcomp-ssreflect -y || echo "Optional: mathcomp not installed"

    - name: Verify Coq installation
      if: steps.check-coq.outputs.has_files == 'true'
      run: |
        eval $(opam env)
        coqc --version

    - name: Cache Coq dependencies
      if: steps.check-coq.outputs.has_files == 'true'
      uses: actions/cache@v4
      with:
        path: |
          ~/.opam
          _build
        key: ${{ runner.os }}-coq-${{ matrix.coq-version }}-${{ hashFiles('_CoqProject', '**.opam') }}
        restore-keys: |
          ${{ runner.os }}-coq-${{ matrix.coq-version }}-

    - name: Build Coq project
      if: steps.check-coq.outputs.has_files == 'true'
      run: |
        eval $(opam env)
        if [ -f "_CoqProject" ]; then
          coq_makefile -f _CoqProject -o Makefile.coq
          make -f Makefile.coq
        else
          find . -name "*.v" -exec coqc {} \;
        fi

    - name: Run Coq tests
      if: steps.check-coq.outputs.has_files == 'true'
      run: |
        eval $(opam env)
        if [ -f "Makefile.coq" ]; then
          make -f Makefile.coq test || echo "No tests defined"
        else
          echo "No Makefile.coq found - skipping tests"
        fi
