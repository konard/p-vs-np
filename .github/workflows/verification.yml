name: Formal Verification Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lean-verification:
    name: Lean Verification
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Elan (Lean version manager)
      run: |
        curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
        echo "$HOME/.elan/bin" >> $GITHUB_PATH

    - name: Cache Lean dependencies
      uses: actions/cache@v4
      with:
        path: |
          .lake
          ~/.elan
        key: ${{ runner.os }}-lean-${{ hashFiles('lakefile.lean', 'lean-toolchain') }}
        restore-keys: |
          ${{ runner.os }}-lean-

    - name: Build and test Lean
      run: |
        if [ -f "lakefile.lean" ]; then
          lean --version
          lake build
          lake test || echo "No tests defined"
        else
          echo "✓ No Lean files - skipping"
        fi

  coq-verification:
    name: Coq Verification
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for Coq files
      id: check-coq
      run: |
        if [ -f "_CoqProject" ] || ls *.v 1> /dev/null 2>&1; then
          echo "has_files=true" >> $GITHUB_OUTPUT
        else
          echo "has_files=false" >> $GITHUB_OUTPUT
          echo "✓ No Coq files - skipping"
        fi

    - name: Set up OCaml
      if: steps.check-coq.outputs.has_files == 'true'
      uses: ocaml/setup-ocaml@v2
      with:
        ocaml-compiler: 4.14.x

    - name: Install Coq
      if: steps.check-coq.outputs.has_files == 'true'
      run: |
        opam install coq.latest -y
        opam install coq-mathcomp-ssreflect -y || true

    - name: Cache Coq dependencies
      if: steps.check-coq.outputs.has_files == 'true'
      uses: actions/cache@v4
      with:
        path: |
          ~/.opam
          _build
        key: ${{ runner.os }}-coq-${{ hashFiles('_CoqProject', '**.opam') }}
        restore-keys: |
          ${{ runner.os }}-coq-

    - name: Build and test Coq
      if: steps.check-coq.outputs.has_files == 'true'
      run: |
        eval $(opam env)
        coqc --version
        if [ -f "_CoqProject" ]; then
          coq_makefile -f _CoqProject -o Makefile.coq
          make -f Makefile.coq
        else
          coqc *.v
        fi

  isabelle-verification:
    name: Isabelle Verification
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for Isabelle files
      id: check-isabelle
      run: |
        if ls *.thy 1> /dev/null 2>&1; then
          echo "has_files=true" >> $GITHUB_OUTPUT
        else
          echo "has_files=false" >> $GITHUB_OUTPUT
          echo "✓ No Isabelle files - skipping"
        fi

    - name: Install Isabelle
      if: steps.check-isabelle.outputs.has_files == 'true'
      run: |
        wget https://isabelle.in.tum.de/dist/Isabelle2024_linux.tar.gz
        tar xzf Isabelle2024_linux.tar.gz
        echo "$PWD/Isabelle2024/bin" >> $GITHUB_PATH

    - name: Build and test Isabelle
      if: steps.check-isabelle.outputs.has_files == 'true'
      run: |
        isabelle version
        isabelle build -D .

  agda-verification:
    name: Agda Verification
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for Agda files
      id: check-agda
      run: |
        if ls *.agda 1> /dev/null 2>&1; then
          echo "has_files=true" >> $GITHUB_OUTPUT
        else
          echo "has_files=false" >> $GITHUB_OUTPUT
          echo "✓ No Agda files - skipping"
        fi

    - name: Set up Haskell
      if: steps.check-agda.outputs.has_files == 'true'
      uses: haskell/actions/setup@v2
      with:
        ghc-version: '9.4'
        cabal-version: '3.10'

    - name: Install Agda
      if: steps.check-agda.outputs.has_files == 'true'
      run: |
        cabal update
        cabal install Agda
        echo "$HOME/.cabal/bin" >> $GITHUB_PATH

    - name: Build and test Agda
      if: steps.check-agda.outputs.has_files == 'true'
      run: |
        agda --version
        agda --safe *.agda

  summary:
    name: Verification Summary
    runs-on: ubuntu-latest
    needs: [lean-verification, coq-verification, isabelle-verification, agda-verification]
    if: always()

    steps:
    - name: Summary
      run: |
        echo "## Formal Verification Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Tool | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Lean | ${{ needs.lean-verification.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Coq | ${{ needs.coq-verification.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Isabelle | ${{ needs.isabelle-verification.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Agda | ${{ needs.agda-verification.result }} |" >> $GITHUB_STEP_SUMMARY
