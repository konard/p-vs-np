name: Formal Verification Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lean-verification:
    name: Lean Verification
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Elan (Lean version manager)
      run: |
        curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
        echo "$HOME/.elan/bin" >> $GITHUB_PATH

    - name: Verify Lean installation
      run: |
        lean --version
        lake --version

    - name: Cache Lean toolchain
      uses: actions/cache@v4
      with:
        path: |
          ~/.elan
        key: ${{ runner.os }}-lean-elan-v2-${{ hashFiles('lakefile.lean') }}
        restore-keys: |
          ${{ runner.os }}-lean-elan-v2-

    - name: Clean stale build artifacts
      run: |
        # Always clean .lake directory to ensure fresh build with current sources
        # This prevents stale compiled artifacts from causing build failures
        echo "Cleaning .lake directory for fresh build..."
        rm -rf .lake

    - name: Build and test Lean
      run: |
        if [ -f "lakefile.lean" ]; then
          echo "=== Lean Verification ==="
          lean --version
          echo ""
          echo "Building Lean project..."
          lake build
          echo "✓ Lean build completed successfully!"
          echo ""
          lake test || echo "No tests defined"
        else
          echo "✓ No Lean files - skipping"
        fi

  rocq-verification:
    name: Rocq Verification
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for Rocq files
      id: check-rocq
      run: |
        if [ -f "_CoqProject" ] || find . -name "*.v" -print -quit | grep -q .; then
          echo "has_files=true" >> $GITHUB_OUTPUT
        else
          echo "has_files=false" >> $GITHUB_OUTPUT
          echo "✓ No Rocq files - skipping"
        fi

    - name: Fix permissions for docker
      if: steps.check-rocq.outputs.has_files == 'true'
      run: sudo chown -R 1000:1000 .

    - name: Build and test Rocq
      if: steps.check-rocq.outputs.has_files == 'true'
      uses: coq-community/docker-coq-action@v1
      with:
        custom_image: 'rocq/rocq-prover:9.0'
        custom_script: |
          startGroup "Rocq version"
            rocq --version
          endGroup
          startGroup "Verify Rocq files"
            if [ -f "_CoqProject" ]; then
              echo "Building Rocq project with _CoqProject..."
              rocq makefile -f _CoqProject -o Makefile.coq
              make -f Makefile.coq
            else
              echo "Verifying Rocq files..."
              find . -name "*.v" -type f | while read -r file; do
                echo "Checking: $file"
                rocq compile "$file" && echo "✓ $file verified successfully" || exit 1
              done
            fi
            echo "✓ All Rocq files verified successfully!"
          endGroup

    - name: Revert permissions
      if: ${{ always() && steps.check-rocq.outputs.has_files == 'true' }}
      run: sudo chown -R 1001:116 .

# Isabelle verification removed - proofs archived to ./archive/isabelle/
# See https://github.com/konard/p-vs-np/issues/530

# Temporarily disabled - Agda installation takes ~20 minutes
  # TODO: Re-enable once we have better caching or use pre-built Agda
  # agda-verification:
  #   name: Agda Verification
  #   runs-on: ubuntu-latest
  #
  #   steps:
  #   - name: Checkout repository
  #     uses: actions/checkout@v4
  #
  #   - name: Check for Agda files
  #     id: check-agda
  #     run: |
  #       if find . -name "*.agda" -print -quit | grep -q .; then
  #         echo "has_files=true" >> $GITHUB_OUTPUT
  #       else
  #         echo "has_files=false" >> $GITHUB_OUTPUT
  #         echo "✓ No Agda files - skipping"
  #       fi
  #
  #   - name: Set up Haskell
  #     if: steps.check-agda.outputs.has_files == 'true'
  #     uses: haskell/actions/setup@v2
  #     with:
  #       ghc-version: '9.4'
  #       cabal-version: '3.10'
  #
  #   - name: Cache Agda
  #     if: steps.check-agda.outputs.has_files == 'true'
  #     uses: actions/cache@v4
  #     with:
  #       path: |
  #         ~/.cabal/store
  #         ~/.cabal/bin
  #         dist-newstyle
  #       key: ${{ runner.os }}-agda-${{ hashFiles('**/*.agda') }}
  #       restore-keys: |
  #         ${{ runner.os }}-agda-
  #
  #   - name: Install Agda
  #     if: steps.check-agda.outputs.has_files == 'true'
  #     run: |
  #       if ! command -v agda &> /dev/null; then
  #         cabal update
  #         cabal install Agda
  #       else
  #         echo "✓ Agda already installed (from cache)"
  #       fi
  #       echo "$HOME/.cabal/bin" >> $GITHUB_PATH
  #
  #   - name: Build and test Agda
  #     if: steps.check-agda.outputs.has_files == 'true'
  #     run: |
  #       echo "=== Agda Verification ==="
  #       agda --version
  #       echo ""
  #       echo "Verifying Agda files..."
  #       find . -name "*.agda" -type f -print0 | while IFS= read -r -d '' file; do
  #         echo "Checking: $file"
  #         agda --safe "$file" && echo "✓ $file verified successfully" || exit 1
  #       done
  #       echo ""
  #       echo "✓ All Agda files verified successfully!"

  summary:
    name: Verification Summary
    runs-on: ubuntu-latest
    needs: [lean-verification, rocq-verification]
    if: always()

    steps:
    - name: Summary
      run: |
        echo "## Formal Verification Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Tool | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Lean | ${{ needs.lean-verification.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Rocq | ${{ needs.rocq-verification.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "_Note: Isabelle proofs archived to ./archive/isabelle/_" >> $GITHUB_STEP_SUMMARY
        echo "_Note: Agda verification temporarily disabled due to long build times (~20 minutes)_" >> $GITHUB_STEP_SUMMARY
