name: Formal Verification Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lean-verification:
    name: Lean Verification
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Elan (Lean version manager)
      run: |
        curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
        echo "$HOME/.elan/bin" >> $GITHUB_PATH

    - name: Cache Lean toolchain
      uses: actions/cache@v4
      with:
        path: |
          ~/.elan
        key: ${{ runner.os }}-lean-elan-${{ hashFiles('lakefile.lean') }}
        restore-keys: |
          ${{ runner.os }}-lean-elan-

    - name: Clean stale build artifacts
      run: |
        # Always clean .lake directory to ensure fresh build with current sources
        # This prevents stale compiled artifacts from causing build failures
        echo "Cleaning .lake directory for fresh build..."
        rm -rf .lake

    - name: Build and test Lean
      run: |
        if [ -f "lakefile.lean" ]; then
          echo "=== Lean Verification ==="
          lean --version
          echo ""
          echo "Building Lean project..."
          lake build
          echo "✓ Lean build completed successfully!"
          echo ""
          lake test || echo "No tests defined"
        else
          echo "✓ No Lean files - skipping"
        fi

  coq-verification:
    name: Coq Verification
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for Coq files
      id: check-coq
      run: |
        if [ -f "_CoqProject" ] || find . -name "*.v" -print -quit | grep -q .; then
          echo "has_files=true" >> $GITHUB_OUTPUT
        else
          echo "has_files=false" >> $GITHUB_OUTPUT
          echo "✓ No Coq files - skipping"
        fi

    - name: Fix permissions for docker
      if: steps.check-coq.outputs.has_files == 'true'
      run: sudo chown -R 1000:1000 .

    - name: Build and test Coq
      if: steps.check-coq.outputs.has_files == 'true'
      uses: coq-community/docker-coq-action@v1
      with:
        coq_version: '8.20'
        custom_script: |
          startGroup "Coq version"
            coqc --version
          endGroup
          startGroup "Verify Coq files"
            if [ -f "_CoqProject" ]; then
              echo "Building Coq project with _CoqProject..."
              coq_makefile -f _CoqProject -o Makefile.coq
              make -f Makefile.coq
            else
              echo "Verifying Coq files..."
              find . -name "*.v" -type f | while read -r file; do
                echo "Checking: $file"
                coqc "$file" && echo "✓ $file verified successfully" || exit 1
              done
            fi
            echo "✓ All Coq files verified successfully!"
          endGroup

    - name: Revert permissions
      if: ${{ always() && steps.check-coq.outputs.has_files == 'true' }}
      run: sudo chown -R 1001:116 .

  isabelle-verification:
    name: Isabelle Verification
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for Isabelle files
      id: check-isabelle
      run: |
        if find . -name "*.thy" -print -quit | grep -q .; then
          echo "has_files=true" >> $GITHUB_OUTPUT
        else
          echo "has_files=false" >> $GITHUB_OUTPUT
          echo "✓ No Isabelle files - skipping"
        fi

    - name: Cache Isabelle installation
      if: steps.check-isabelle.outputs.has_files == 'true'
      id: cache-isabelle
      uses: actions/cache@v4
      with:
        path: Isabelle2025-1
        key: ${{ runner.os }}-isabelle-2025-1

    - name: Install Isabelle
      if: steps.check-isabelle.outputs.has_files == 'true' && steps.cache-isabelle.outputs.cache-hit != 'true'
      run: |
        # Retry logic with multiple mirrors and attempts
        ISABELLE_VERSION="Isabelle2025-1"
        MIRRORS=(
          "https://isabelle.in.tum.de/dist/${ISABELLE_VERSION}_linux.tar.gz"
          "https://mirror.ctan.org/systems/isabelle/${ISABELLE_VERSION}_linux.tar.gz"
          "https://isabelle.sketis.net/dist/${ISABELLE_VERSION}_linux.tar.gz"
        )
        MAX_RETRIES=3
        DOWNLOAD_SUCCESS=false

        for mirror in "${MIRRORS[@]}"; do
          echo "Trying mirror: $mirror"
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "  Attempt $attempt of $MAX_RETRIES..."
            if wget --timeout=120 --tries=1 -q "$mirror" -O "${ISABELLE_VERSION}_linux.tar.gz"; then
              echo "  Download successful!"
              DOWNLOAD_SUCCESS=true
              break 2
            else
              echo "  Failed, waiting 10 seconds before retry..."
              sleep 10
            fi
          done
        done

        if [ "$DOWNLOAD_SUCCESS" = false ]; then
          echo "ERROR: All download attempts failed"
          exit 1
        fi

        tar xzf ${ISABELLE_VERSION}_linux.tar.gz

    - name: Add Isabelle to PATH
      if: steps.check-isabelle.outputs.has_files == 'true'
      run: |
        echo "$PWD/Isabelle2025-1/bin" >> $GITHUB_PATH

    - name: Generate ROOTS file
      if: steps.check-isabelle.outputs.has_files == 'true'
      run: |
        echo "Generating ROOTS file from individual ROOT files..."
        find . -name ROOT -path "*/isabelle/*" | sed 's|/ROOT||' | sed 's|^\./||' | sort > ROOTS
        echo "Found $(wc -l < ROOTS) Isabelle sessions:"
        cat ROOTS

    - name: Build and test Isabelle
      if: steps.check-isabelle.outputs.has_files == 'true'
      run: |
        echo "=== Isabelle Verification ==="
        isabelle version
        echo ""
        echo "Building Isabelle theories..."
        isabelle build -D .
        echo ""
        echo "✓ All Isabelle theories verified successfully!"

# Temporarily disabled - Agda installation takes ~20 minutes
  # TODO: Re-enable once we have better caching or use pre-built Agda
  # agda-verification:
  #   name: Agda Verification
  #   runs-on: ubuntu-latest
  #
  #   steps:
  #   - name: Checkout repository
  #     uses: actions/checkout@v4
  #
  #   - name: Check for Agda files
  #     id: check-agda
  #     run: |
  #       if find . -name "*.agda" -print -quit | grep -q .; then
  #         echo "has_files=true" >> $GITHUB_OUTPUT
  #       else
  #         echo "has_files=false" >> $GITHUB_OUTPUT
  #         echo "✓ No Agda files - skipping"
  #       fi
  #
  #   - name: Set up Haskell
  #     if: steps.check-agda.outputs.has_files == 'true'
  #     uses: haskell/actions/setup@v2
  #     with:
  #       ghc-version: '9.4'
  #       cabal-version: '3.10'
  #
  #   - name: Cache Agda
  #     if: steps.check-agda.outputs.has_files == 'true'
  #     uses: actions/cache@v4
  #     with:
  #       path: |
  #         ~/.cabal/store
  #         ~/.cabal/bin
  #         dist-newstyle
  #       key: ${{ runner.os }}-agda-${{ hashFiles('**/*.agda') }}
  #       restore-keys: |
  #         ${{ runner.os }}-agda-
  #
  #   - name: Install Agda
  #     if: steps.check-agda.outputs.has_files == 'true'
  #     run: |
  #       if ! command -v agda &> /dev/null; then
  #         cabal update
  #         cabal install Agda
  #       else
  #         echo "✓ Agda already installed (from cache)"
  #       fi
  #       echo "$HOME/.cabal/bin" >> $GITHUB_PATH
  #
  #   - name: Build and test Agda
  #     if: steps.check-agda.outputs.has_files == 'true'
  #     run: |
  #       echo "=== Agda Verification ==="
  #       agda --version
  #       echo ""
  #       echo "Verifying Agda files..."
  #       find . -name "*.agda" -type f -print0 | while IFS= read -r -d '' file; do
  #         echo "Checking: $file"
  #         agda --safe "$file" && echo "✓ $file verified successfully" || exit 1
  #       done
  #       echo ""
  #       echo "✓ All Agda files verified successfully!"

  summary:
    name: Verification Summary
    runs-on: ubuntu-latest
    needs: [lean-verification, coq-verification, isabelle-verification]
    if: always()

    steps:
    - name: Summary
      run: |
        echo "## Formal Verification Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Tool | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Lean | ${{ needs.lean-verification.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Coq | ${{ needs.coq-verification.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Isabelle | ${{ needs.isabelle-verification.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "_Note: Agda verification temporarily disabled due to long build times (~20 minutes)_" >> $GITHUB_STEP_SUMMARY
